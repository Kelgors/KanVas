/**
* Kanvas
* @package ec
* @version 0.3.1 (2013-04-07)
* @author Matthieu BOHEAS <matthieuboheas[at]gmail.com>
* @copyright Copyright (c) 2013 Matthieu BOHEAS
* @link https://github.com/Kelgors/Kanvas
* @license http://opensource.org/licenses/mit-license.php MIT License
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy of this
* software and associated documentation files (the "Software"), to deal in the Software
* without restriction, including without limitation the rights to use, copy, modify, merge,
* publish, distribute, sublicense, and/or sell copies of the Software, and to permit
* persons to whom the Software is furnished to do so, subject to the following conditions:
* 
* The above copyright notice and this permission notice shall be included in all copies
 * or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
* INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR
* PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
* LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
* OR OTHER DEALINGS IN THE SOFTWARE.
*
* Please minify before use
*/

(function(){window.kan={LANG:'FR-fr',DEBUG:true,extend:function(that,p){var fnTest=/xyz/.test(function(){xyz;})?/\bparent\b/:/.*/;var parent=p.prototype;var prop=that.prototype;var prototype={};var type=that.prototype.info.type.split('.')[1];for(var name in prop){if(typeof(prop[name])=='function'&&typeof(parent[name])=='function'&&fnTest.test(prop[name]))
{prototype[name]=(function(name,fn){return function(){var tmp=this.parent;this.parent=parent[name];var ret=fn.apply(this,arguments);this.parent=tmp;return ret;};})(name,prop[name]);}else{prototype[name]=prop[name];}}
for(var name in parent){if(!prototype[name]&&name!='to'+type){prototype[name]=parent[name];}else if(prototype[name]&&kan.isNativeFunction(prototype[name])){prototype[name]=parent[name];}}
that.prototype=kan._clone(prototype);that.prototype.info.parent=kan._clone(p.prototype.info);},_clone:function(obj){if(obj==null||typeof(obj)!='object'){return obj;}
if(obj instanceof Array){return obj.slice(0);}
var temp=obj.constructor();for(var key in obj)
temp[key]=kan._clone(obj[key]);return temp;},ready:function(fn,load){if(!fn){return;}
var event,f;event=load||'DOMContentLoaded';if(event==='load'){window.onload=fn;}else{f=function(e){kan.EventManager.remove(event,f,false);fn();};kan.EventManager.add(event,f,false);}},_set_requestAnimFrame:function(){window.requestAnimFrame=(function(){return(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60);});})();},isNativeFunction:function(f){return!!f&&(typeof f).toLowerCase()=='function'&&(f===Function.prototype||/^\s*function\s*(\b[a-z$_][a-z0-9$_]*\b)*\s*\((|([a-z$_][a-z0-9$_]*)(\s*,[a-z$_][a-z0-9$_]*)*)\)\s*{\s*\[native code\]\s*}\s*$/i.test(String(f)));},equal:function(o1,o2){if(typeof(o1)!=typeof(o2)){return false;}
if(typeof(o1)!='object'){return o1===o2;}
for(var i in this){switch(typeof(this[i])){case'function':continue;case'object':if(this[i]instanceof Date&&o[i]instanceof Date){if(this[i].getTime()!=o[i].getTime()){return false;}}else if(this[i]instanceof Array&&o[i]instanceof Array&&this[i].length==o[i].length||this[i]instanceof Object&&o[i]instanceof Object){for(var n in this[i]){if(typeof(this[i][n])=='function'){continue;}
if(this[i][n].equals){if(!this[i][n].equals(o[i][n])){return false;}}else if(typeof(this[i][n])=='object'&&typeof(o[i][n])=='object'){if(!kan.equal(this[i][n],o[i][n])){return false;}}else{if(this[i][n]!==o[i][n]){return false;}}}}else{return false;}
break;default:if(this[i]!==o[i]){return false;}
break;}}},typeof:function(o){return o.info?o.info.type:typeof(o);},Guid:{create:function(dashes){dashes=dashes==null?true:dashes;var s=[];var hexDigits="0123456789abcdef";for(var i=0;i<36;i++){s[i]=hexDigits.substr(Math.floor(Math.random()*0x10),1);}
s[14]="4";s[19]=hexDigits.substr((s[19]&0x3)|0x8,1);s[8]=s[13]=s[18]=s[23]=dashes?'-':'';var uuid=s.join("");return uuid;}},Number:{compare:function(n1,n2){if(n1>n2){return 1;}else if(n1<n2){return-1;}
return 0;}}};window.kan._set_requestAnimFrame();kan.Mouse={position:{rel:null,abs:null},getAbsolutePosition:function(e){kan.Mouse._update(e);return kan.Mouse.position.abs;},getPosition:function(e){kan.Mouse._update(e);return kan.Mouse.position.rel;},_update:function(e){kan.Mouse.position.abs=new kan.Point({x:e.clientX,y:e.clientY});kan.Mouse.position.rel=new kan.Point({x:e.layerX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft),y:e.layerY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop)});},getX:function(e){return e.layerX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft);},getY:function(e){return e.layerY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop);}};kan.EventManager=function(){this.state={clicked:false,pressed:false,dragging:false};};kan.EventManager.prototype={state:null,execute:function(e){var dontStop=true;if(this[e.type]){for(var i in this[e.type]){if(typeof(this[e.type][i])=='function'){if(this[e.type][i](e)==false){dontStop=false;break;}}}}
if(!dontStop){if(e.preventDefault){e.preventDefault();}
if(e.stopImmediatePropagation){e.stopImmediatePropagation();}
e.cancelBubble=true;e.returnValue=false;}
return dontStop;},reset:function(){for(var i in this.state){if(typeof(this.state[i])=='boolean'){this.state[i]=false;}}},click:null,mouseup:null,mousedown:null,mousemove:null};kan.EventManager.add=function(e,f,b){return document.addEventListener?document.addEventListener(e,f,b):document.attachEvent(e,f,b);};kan.EventManager.remove=function(e,f,b){return document.removeEventListener?document.removeEventListener(e,f,b):document.detachEvent(e,f,b);};kan.Object=function(settings){this.info=kan._clone(this.info);for(var i in settings){this[i]=settings[i];}
this.info.ID=kan.Guid.create();};kan.Object.prototype={info:{ID:null,type:'Object',getType:function(){return kan.Object;}},clone:function(){var o=this.info?new kan[this.info.type]():this.constructor();for(var i in this){if(!this[i]){continue;}
if(typeof(this[i])=='object'){o[i]=this[i].inheritsof?this[i].clone():kan._clone(this[i]);}else if(typeof(this[i])!='function'){o[i]=this[i];}}
return o;},equals:function(o){if(!o.inheritsof){return false;}
if(o.inheritsof(kan.Object)){for(var i in this){switch(typeof(this[i])){case'function':continue;case'object':if(this[i]instanceof Date&&o[i]instanceof Date){if(this[i].getTime()!=o[i].getTime()){return false;}}else if(this[i]instanceof Array&&o[i]instanceof Array&&this[i].length==o[i].length){for(var n in this[i]){if(this[i][n].equals){if(!this[i][n].equals(o[i][n])){return false;}}else if(typeof(this[i][n])=='object'&&typeof(o[i][n])=='object'){if(!(new kan.Object(this[i][n]).equals(o[i][n]))){return false;}}else{return false;}}}
break;default:if(this[i]!==o[i]){return false;}
break;}}
return true;}
return false;},compare:function(o){var t=new kan[this.info.type]();for(var i in this){switch(typeof(this[i])){case'number':t[i]=kan.Number.compare(this[i],o[i]);break;case'string':t[i]=this[i].localeCompare(o[i]);break;case'boolean':t[i]=this[i]==o[i];break;case'object':if(this[i].compare){t[i]=this[i].compare(o[i]);}else if(o[i]instanceof Date){t[i]=kan.Number.compare(this[i].getTime(),o[i].getTime());}else if(o[i]instanceof Array){t[i]=kan.Number.compare(this[i].length,o[i].length);}else{t[i]=new kan.Object(this[i]).compare(o[i]);}
break;}
return t;}},stringify:function(){return JSON.stringify(this,function(k,v){if(k==='parent'){return undefined;}
return v;});},inheritsof:function(type){return this._getInheritance(this.info).match(new RegExp(type.prototype.info.type))==type.prototype.info.type;},_getInheritance:function(info){return info.parent!=null?info.type+'|'+this._getInheritance(info.parent):info.type;},toString:function(){return this.info.type;}};kan.List=function(settings){this.types={};this.items=new Array();if(settings&&settings instanceof Object&&settings.items){this.addRange(settings.items.slice(0));delete settings.items;}else if(settings instanceof Array){this.addRange(settings.slice(0));settings=null;}
for(var i in settings){this[i]=settings[i];}};kan.List.prototype={info:{type:'List',getType:function(){return kan.List;}},of:null,items:null,types:null,add:function(o){if(!o)return false;this.items.push(o);var t=kan.typeof(o);if(!this.types[t]){this.types[t]=0;}
this.types[t]+=1;this._checkType();return this;},_checkType:function(){this.of=null;if(this.empty()){return;}
var type=null;for(var t in this.types){if(this.types[t]>0){if(!type){type=t;}else{this.of='mixed';break;}}}
if(!this.of){this.of=type;}},addRange:function(a){if(a instanceof Array){this.items=this.items.concat(a);var type=null;for(var index=0;index<a.length;index++){type=kan.typeof(a[index]);if(!this.types[type]){this.types[type]=0;}
this.types[type]+=1;}}else if(a.info&&a.inheritsof(kan.List)){this.items=this.items.concat(a.items);for(var t in a.types){if(!this.types[t]){this.types[t]=0;}
this.types[t]+=a.types[t];}}
this._checkType();return this;},remove:function(o){var type=typeof(o);switch(type){case'function':for(var index=0;index<this.items.length;index++){if(o.call(this.items[index],index)==true){this.types[kan.typeof(this.items[index])]-=1;this.items.splice(index,1);index-=1;}}
break;case'object':for(var index=0;index<this.items.length;index++){if(o.equals&&o.equals(this.items[index])){this.types[type]-=1;this.items.splice(index,1);index-=1;}else if(kan.equal(o,this.items[index])){this.types[type]-=1;this.items.splice(index,1);index-=1;}}
break;default:for(var index=0;index<this.items.length;index++){if(this.items[index]===o){this.types[type]-=1;this.items.splice(index,1);index-=1;}}}
this._checkType();return this;},removeAt:function(index){this.types[kan.typeof(this.items[index])]-=1;this.items.splice(index,1);this._checkType();return this;},exchange:function(index1,index2){var tmp=this.items[index1];this.items[index1]=this.items[index2];this.items[index2]=tmp;},moveUp:function(o){switch(typeof(o)){case'function':for(var index=0;index<this.items.length;index++){if(o.call(this.items[index],index)){this.items[index]=this.items[index-1];this.items[index-1]=o;}}
break;case'object':for(var index=0;index<this.items.length;index++){if(o.equals&&o.equals(this.items[index])){this.items[index]=this.items[index-1];this.items[index-1]=o;}else if(kan.equal(o,this.items[index])){this.items[index]=this.items[index-1];this.items[index-1]=o;}}
break;default:for(var index=0;index<this.items.length;index++){if(this.items[index]===o&&index!=0){this.items[index]=this.items[index-1];this.items[index-1]=o;}}}
return this;},moveDown:function(o){switch(typeof(o)){case'function':for(var index=0;index<this.items.length;index++){if(o.call(this.items[index],index)){this.items[index]=this.items[index+1];this.items[index+1]=o;}}
break;case'object':for(var index=0;index<this.items.length;index++){if(o.equals&&o.equals(this.items[index])){this.items[index]=this.items[index+1];this.items[index+1]=o;}else if(kan.equal(o,this.items[index])){this.items[index]=this.items[index+1];this.items[index+1]=o;}}
break;default:for(var index=0;index<this.items.length;index++){if(this.items[index]===o&&index!=this.items.length){this.items[index]=this.items[index+1];this.items[index+1]=o;}}}
return this;},moveToFirst:function(o){var index=this.getIndex(o);this.exchange(index,0);return this;},moveToLast:function(o){var index=this.getIndex(o);this.exchange(index,this.items.length-1);return this;},join:function(separator,fn){if(!fn){return this.items.join(separator);}else{var result='';for(var index in this.items){result+=fn.call(this.items[index],index)+separator;}
return result.substr(0,result.length-1);}},clear:function(){this.items=new Array();this.types={};this.of=null;return this;},empty:function(){return this.items.length==0;},count:function(){return this.items.length;},sort:function(fn){this.items.sort(fn);},get:function(index){return this.items[index];},set:function(index,value){if(this.items[index]){this.types[kan.typeof(this.items[index])]-=1;this.items[index]=value;this.types[kan.typeof(value)]+=1;this._checkType();}},item:function(index,object){if(object){this.types[kan.typeof(this.items[index])]-=1;this.items[index]=object;this.types[kan.typeof(object)]+=1;this._checkType();}
return this.items[index];},contains:function(o){if(typeof(o)=='object'){for(var index=0;index<this.items.length;index++){if(o.equals&&o.equals(this.items[index])){return true;}}}else{for(var index=0;index<this.items.length;index++){if(o===this.items[index]){return true;}}}
return false;},getIndex:function(o){if(typeof(o)=='object'){for(var index=0;index<this.items.length;index++){if(o.equals){if(o.equals(this.items[index]))
return index;}else if(kan.equal(o,this.items[index])){return index;}}}else{return this.items.indexOf(o);}
return-1;},first:function(){return this.items[0];},last:function(){return this.items[this.items.length-1];},lastIndex:function(){return this.items.length-1;},each:function(fn){var returnValue;for(var index=0;index<this.items.length;index++){if(returnValue=fn.call(this.items[index],index)){return returnValue;}}
return false;},toString:function(){return'{ of: '+this.of+', items: { '+this.items.join(', ')+' }';},equals:function(o){if(o.inheritsof&&o.inheritsof(kan.List)&&o.count()==this.count()&&o.of===this.of){for(var index=0;index<this.items.length;index++){if(this.items[i].equals){if(!this.items.equals(o.items[i])){return false;}}else{if(!kan.equal(this.items[i],o.items[i])){return false;}}}
return true;}
return false;},clone:function(){var l=new kan.List();l.items=this.items.slice(0);l.of=this.of;return l;}};kan.extend(kan.List,kan.Object);kan.ShapeList=function(settings){kan.List.call(this,settings);};kan.ShapeList.prototype={info:{type:'ShapeList',getType:function(){return kan.ShapeList;}},add:function(o){if(o.draw&&o.update){kan.List.prototype.add.call(this,o);}},moveToFirst:function(o){var index;if(typeof(o)=='number'){index=o;o=this.items[index];}else{index=this.getIndex(o);}
o.lastZIndex=o.zIndex;o.zIndex=this.first().zIndex-1;this.items.slice(index,1);this.items.unshift(o);},moveToLast:function(o){var index;if(typeof(o)=='number'){index=o;o=this.items[index];}else{index=this.getIndex(o);}
o.lastZIndex=o.zIndex;o.zIndex=this.last().zIndex+1;this.items.slice(index,1);this.items.push(o);},moveDown:function(o){var index;if(typeof(o)=='number'){index=o;o=this.items[index];}else{index=this.getIndex(o);}
o.lastZIndex=o.zIndex;o.zIndex=this.items[index-1]?this.items[index-1].zIndex-1:o.zIndex-1;this.exchange(index,index-1);},moveUp:function(o){var index;if(typeof(o)=='number'){index=o;o=this.items[index];}else{index=this.getIndex(o);}
o.lastZIndex=o.zIndex;o.zIndex=this.items[index+1]?this.items[index+1].zIndex+1:o.zIndex+1;this.exchange(index,index+1);},moveBack:function(o){o.zIndex=o.lastZIndex;},getIndex:function(o){for(var index=0;index<this.items;index++){if(this.items[index].info.ID===o.info.ID){return index;}}
return-1;}};kan.extend(kan.ShapeList,kan.List);kan.Font=function(settings){kan.Object.call(this,settings);};kan.Font.prototype={info:{type:'kan.Font',getType:function(){return kan.Font;}},style:'normal',smallcaps:false,weight:'normal',family:'Arial',fill:null,stroke:null,size:12,lineWidth:1,baseLine:'top',textAlign:'left',set:function(ctx){this.applyFont(ctx);ctx.lineWidth=this.lineWidth;if(this.fill)
ctx.fillStyle=this.fill instanceof kan.Color?this.fill.toRGBA():this.fill;if(this.stroke)
ctx.strokeStyle=this.stroke instanceof kan.Color?this.stroke.toRGBA():this.stroke;},applyFont:function(ctx){var caps=this.smallcaps?'small-caps':'';ctx.font=caps+' '+this.style+' '+this.weight+' '+this.size+'px '+' '+this.family;ctx.textBaseline=this.baseLine;ctx.textAlign=this.textAlign;},toString:function(){var caps=this.smallcaps?'small-caps':'';return caps+' '+this.style+' '+this.weight+' '+this.size+'px '+' '+this.family;}};kan.extend(kan.Font,kan.Object);kan.Color=function(settings){kan.Object.call(this,settings);};kan.Color.prototype={info:{type:'Color',getType:function(){return kan.Color;}},r:0,g:0,b:0,a:1,valid:function(){this.r=this.r>255?255:this.r<0?0:this.r;this.g=this.g>255?255:this.g<0?0:this.g;this.b=this.b>255?255:this.b<0?0:this.b;},toHexa:function(){this.valid();return'#'+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1);},toString:function(){return'{ r: '+this.r+', g: '+this.g+', b: '+this.b+', a: '+this.a+' }';},toRGBA:function(){this.valid();return'rgba( '+this.r+', '+this.g+', '+this.b+', '+this.a+')';},toRGB:function(){this.valid();return'rgb( '+this.r+', '+this.g+', '+this.b+')';},inverts:function(){this.r=Math.abs(this.r-255);this.g=Math.abs(this.g-255);this.b=Math.abs(this.b-255);return this;},equals:function(o){return this.r==o.r&&this.g==o.g&&this.b==o.b&&this.a==o.a;},compare:function(o){var r=0,g=0,b=0;if(this.r>o.r){r=1;}else if(this.r<o.r){r=-1;}
if(this.g>o.g){g=1;}else if(this.g<o.g){g=-1;}
if(this.b>o.b){b=1;}else if(this.b<o.b){b=-1;}
if(this.a>o.a){a=1;}else if(this.a<o.a){a=-1;}
return new kan.Color({r:r,g:g,b:b,a:a});},clone:function(){return new kan.Color({r:this.r,g:this.g,b:this.b,a:this.a});}};kan.extend(kan.Color,kan.Object);kan.Color.invert=function(o){return new kan.Color({r:Math.abs(o.r-255),g:Math.abs(o.g-255),b:Math.abs(o.b-255),a:o.a});};kan.Color.random=function(){return new kan.Color({r:Math.floor(Math.random()*256),g:Math.floor(Math.random()*256),b:Math.floor(Math.random()*256),a:1});};kan.Color.BLACK=function(){return new kan.Color({name:'black',r:0,g:0,b:0});};kan.Color.WHITE=function(){return new kan.Color({r:255,g:255,b:255,name:'white'});};kan.Color.RED=function(){return new kan.Color({r:255,name:'red'});};kan.Color.GREEN=function(){return new kan.Color({g:255,name:'green'});};kan.Color.BLUE=function(){return new kan.Color({b:255,name:'blue'});};kan.Color.YELLOW=function(){return new kan.Color({r:255,g:255,name:'yellow'});};kan.Color.MAGENTA=function(){return new kan.Color({r:255,b:255,name:'magenta'});};kan.Color.AQUA=function(){return new kan.Color({g:255,b:255,name:'aqua'});};kan.Color.ORANGE=function(){return new kan.Color({r:255,g:165,name:'orange'});};kan.Color.PURPLE=function(){return new kan.Color({r:160,g:32,b:240,name:'purple'});};kan.Color.PINK=function(){return new kan.Color({r:255,g:192,b:203,name:'pink'});};kan.Color.CORNFLOWERBLUE=function(){return new kan.Color({r:100,g:149,b:237,name:'cornflower blue'});}
kan.Color.Gray=function(factor){return(new kan.Color({name:'Gray '+factor,r:factor,g:factor,b:factor}));};kan.Point=function(settings){this.x=0;this.y=0;if(settings){kan.Object.call(this,settings);}};kan.Point.prototype={info:{type:'Point',getType:function(){return kan.Point;}},x:0,y:0,equals:function(o){if(o.x&&o.y){return this.x==o.x&&this.y==o.y;}
return false;},compare:function(o){if(o.x!=null&&o.y!=null){var x=0,y=0;if(this.x>o.x){x=1;}else if(this.x<o.x){x=-1;}
if(this.y>o.y){y=1;}else if(this.y<o.y){y=-1;}
return new kan.Point({x:x,y:y});}
return null;},toString:function(){return'{ x: '+this.x+', y: '+this.y+' }';},toVector2:function(){return new kan.Vector2({x:this.x,y:this.y});}};kan.extend(kan.Point,kan.Object);kan.Vector2=function(settings){kan.Point.call(this,settings);};kan.Vector2.prototype={info:{type:'Vector2',getType:function(){return kan.Vector2;}},adds:function(value){if(typeof(value)=='number'){this.x+=value;this.y+=value;}else if(value.x!=null&&value.y!=null){this.x+=value.x;this.y+=value.y;}
return this;},substracts:function(value){if(typeof(value)=='number'){this.x-=value;this.y-=value;}else if(value.x!=null&&value.y!=null){this.x-=value.x;this.y-=value.y;}
return this;},multiplies:function(value){if(typeof(value)=='number'){this.x*=value;this.y*=value;}else if(value.x!=null&&value.y!=null){this.x*=value.x;this.y*=value.y;}
return this;},divides:function(value){if(typeof(value)=='number'){this.x/=value;this.y/=value;}else if(value.x!=null&&value.y!=null){this.x/=value.x;this.y/=value.y;}
return this;},distance:function(o){if(o.x!=null&&o.y!=null){return Math.sqrt(Math.pow(this.x-o.x,2)+Math.pow(this.y-o.y,2));}
return NaN;},distanceSquared:function(o){if(o.x!=null&&o.y!=null){return Math.pow(this.x-o.x,2)+Math.pow(this.y-o.y,2);}
return NaN;},compare:function(o){if(o.inheritsof(kan.Point)){var x=0,y=0;if(this.x>o.x){x=1;}else if(this.x<o.x){x=-1;}
if(this.y>o.y){y=1;}else if(this.y<o.y){y=-1;}
return new kan.Vector2({x:x,y:y});}}};kan.extend(kan.Vector2,kan.Point);kan.Vector2.add=function(v1,v2){return new kan.Vector2({x:v1.x+v2.x,y:v1.y+v2.y});};kan.Vector2.substract=function(v1,v2){return new kan.Vector2({x:v1.x-v2.x,y:v1.y-v2.y});};kan.Vector2.multiply=function(v1,v2){return new kan.Vector2({x:v1.x*v2.x,y:v1.y*v2.y});};kan.Vector2.divide=function(v1,v2){return new kan.Vector2({x:v1.x/v2.x,y:v1.y/v2.y});};kan.Vector2.distance=function(v1,v2){if(v1.x!=null&&v1.y!=null&&v2.x!=null&&v2.y!=null){return Math.sqrt(Math.pow(v2.x-v1.x,2)+Math.pow(v2.y-v1.y,2));}
return NaN;};kan.Vector2.distanceSquared=function(v1,v2){return v1.clone().distanceSquared(v2);};kan.Vector2.One=function(){return new Vector2({x:1,y:1});};kan.Size=function(settings){if(settings){kan.Object.call(this,settings);}};kan.Size.prototype={info:{type:'Size',getType:function(){return kan.Size;}},width:0,height:0,equals:function(o){if(o.inheritsof&&o.inheritsof(kan.Size)){return this.width==o.width&&this.height==o.height;}else if(typeof(o)=='number'){return this.width==o&&this.height==o;}
return false;},toString:function(){return'{ width: '+this.width+', height: '+this.height+' }';},compare:function(o){if(o.inheritsof(kan.Size)){var w=0,h=0;if(this.width>o.width){w=1;}else if(this.width<o.width){w=-1;}
if(this.height>o.height){h=1;}else if(this.height<o.height){h=-1;}
return new kan.Size({width:w,height:h});}},clone:function(){return new kan.Size({width:this.width,height:this.height});}};kan.extend(kan.Size,kan.Object);kan.Graphics=function(){this.transform=new kan.Object({m11:1,m12:0,m21:0,m22:1,dx:0,dy:0});this.scale=new kan.Point({x:1,y:1});this.rotation=0;this.defaults={transform:this.transform.clone(),scale:this.scale.clone(),rotation:0};kan.Object.call(this);};kan.Graphics.prototype={info:{type:'Graphics',getType:function(){return kan.Graphics;}},transform:null,scale:null,defaults:null,rotation:0,beforedraw:function(ctx){if(this.rotation!=this.defaults.rotation){this._saveContext(ctx);ctx.rotate(this.rotation);}
if(!this.scale.equals(this.defaults.scale)){this._saveContext(ctx);ctx.scale(this.scale.x,this.scale.y);}
if(!this.transform.equals(this.defaults.transform)){this._saveContext(ctx);this.doTransform(ctx);}},afterdraw:function(ctx){this._restoreContext(ctx);},doTransform:function(ctx){ctx.transform(this.transform.m11,this.transform.m12,this.transform.m21,this.transform.m22,this.transform.dx,this.transform.dy);},setScale:function(value){if(typeof(value)=='number'){this.scale.y=this.scale.x=value;}else if(value.x!=null&&value.y!=null){this.scale=value.clone?value.clone():kan._clone(value);}},_contextSaved:false,_saveContext:function(ctx){if(!this._contextSaved){ctx.save();return(this._contextSaved=true);}
return false;},_restoreContext:function(ctx){if(this._contextSaved){ctx.restore();return!(this._contextSaved=false);}
return false;}};kan.extend(kan.Graphics,kan.Object);kan.Shape=function(settings){this.events=new kan.EventManager();this.currentPosition=new kan.Point();this.position=new kan.Point();this.graphics=new kan.Graphics();this.random=Math.random();this.floating={};for(var i in settings){switch(i){case'x':case'y':this.position[i]=settings[i];break;case'width':case'height':if(this.size)
this.size[i]=settings[i];break;case'speed':case'amplitude':this.floating[i]=settings[i];break;default:this[i]=settings[i];break;}}
this.currentPosition=this.position.clone();if(this.clickable){this.on('mousedown',this.eventsHandlers.click.down);this.on('mouseup',this.eventsHandlers.click.up);}
if(this.draggable){if(!this.clickable)
this.on('mousedown',this.eventsHandlers.click.down);this.on('mousemove',this.eventsHandlers.drag.move);this.on('mouseup',this.eventsHandlers.drag.end);}
kan.Object.call(this);};kan.Shape.prototype={info:{type:'Shape',getType:function(){return kan.Shape;}},position:null,zIndex:0,currentPosition:null,fill:null,stroke:null,lineWidth:1,clickable:false,draggable:false,graphics:null,events:null,floating:{speed:null,amplitude:null},random:0,addTo:function(layer){if(layer instanceof Array){layer.push(this);}else if(layer.add){layer.add(this);}
return this;},update:function(data){if(this.floating.speed&&this.floating.amplitude){this.currentPosition.y=this.position.y+Math.cos(data.timer*(this.floating.speed/10))*this.floating.amplitude/10;}else{this.currentPosition.y=this.position.y;}
this.currentPosition.x=this.position.x;},draw:function(){},eventsHandlers:{click:{down:function(e){this.events.state.clicked=false;if(this.contains(e.mousePosition)){this.events.state.pressed=true;kan.Mouse.pressed=true;this.events.state.lastPosition=kan.Vector2.substract(this.position,e.mousePosition);this.info.layer.components.moveToLast(this);if(this.onpressed){this.onpressed(e);}
return false;}
this.events.state.pressed=false;return true;},up:function(e){if(this.contains(e.mousePosition)&&this.events.state.pressed&&!this.events.state.dragging){this.events.state.pressed=false;kan.Mouse.pressed=false;this.events.state.clicked=true;this.info.layer.components.moveBack(this);if(e.which==3&&kan.DEBUG){console.log(this);}
if(this.onclick){return this.onclick(e);}
return false;}
return true;}},drag:{move:function(e){if(this.events.state.pressed){this.position.x=e.mousePosition.x+this.events.state.lastPosition.x;this.position.y=e.mousePosition.y+this.events.state.lastPosition.y;this.events.state.dragging=true;return false;}
return true;},end:function(e){if(this.events.state.dragging){this.position.x=e.mousePosition.x+this.events.state.lastPosition.x;this.position.y=e.mousePosition.y+this.events.state.lastPosition.y;this.events.state.dragging=false;this.events.state.pressed=false;kan.Mouse.pressed=false;this.info.layer.components.moveBack(this);return false;}
return true;}}},compare:function(o){if(o.inheritsof&&o.inheritsof(kan.Shape)){return new o.info.getType()({position:this.position.compare(o.position),currentPosition:this.currentPosition.compare(o.currentPosition)});}
return null;},on:function(e,fn){var events=e.split(' ');for(var i in events){if(!this.events[events[i]]){this.events[events[i]]=new Array();}
this.events[events[i]].push(fn.bind(this));}},off:function(e){var events=e.split(' ');for(var i in events){if(this.events[events[i]]){this.events[events[i]]=null;}}}};kan.extend(kan.Shape,kan.Object);kan.Line=function(settings){this.graphics=new kan.Graphics();this.points=new kan.List(settings.points);delete settings.points;kan.Shape.call(this,settings);};kan.Line.prototype={info:{type:'Line',getType:function(){return kan.Line;}},stroke:null,points:null,width:1,graphics:null,update:function(){},draw:function(data){if(this.stroke&&!this.points.empty()){var ctx=data.context;this.graphics.beforedraw(ctx);ctx.strokeStyle=this.stroke.inhertitsof&&this.stroke.inheritsof(kan.Color)?this.stroke.toRGBA():this.stroke;ctx.lineWidth=this.width;ctx.beginPath();ctx.moveTo(this.points.get(0).x,this.points.get(0).y);this.points.each(function(){ctx.lineTo(this.x,this.y);});ctx.stroke();this.graphics.afterdraw(ctx);}},equals:function(o){if(o.inheritsof&&o.inheritsof(kan.Line)){return this.points.equals(o.points);}
return false;},clone:function(){return new kan.Line({points:this.points.clone()})}};kan.extend(kan.Line,kan.Shape);kan.Text=function(settings){this.value='';this.font=new kan.Font();kan.Shape.call(this,settings);};kan.Text.prototype={info:{type:'Text',getType:function(){return kan.Text;}},value:null,currentPosition:null,getOrigin:function(){return kan.Vector2.add(this.position,this.origin);},update:function(data){if(this.value!=this.lastValue){this.font.applyFont(data.context);this.width=data.context.measureText(this.value).width;this.origin=new kan.Point({x:this.width/2,y:this.size/2});this.currentPosition.x=this.position.x-this.origin.x;this.currentPosition.y=this.position.y+this.origin.y;this.lastValue=this.value;var str=this.value.split('\n');this.multiline=new Array();for(var i in str){this.multiline[i]={content:str[i],width:data.context.measureText(str[i]).width,y:this.position.y+this.font.size*i};}}},draw:function(data){var ctx=data.context;this.graphics.beforedraw(ctx);this.font.set(ctx);if(this.font.fill||this.font.stroke){for(var i in this.multiline){if(this.font.fill)
ctx.fillText(this.multiline[i].content,this.position.x,this.multiline[i].y);if(this.font.stroke)
ctx.strokeText(this.multiline[i].content,this.position.x,this.multiline[i].y);}}
this.graphics.afterdraw(ctx);},compare:function(o){return null;},equals:function(o){if(o.inheritsof&&o.inheritsof(kan.Text)&&this.value===o.value){return this.font.equals(o.font);}else if(typeof(o)=='string'){return this.value==o;}
return false;},clone:function(){return new kan.Text({position:this.position.clone(),font:this.font.clone(),value:this.value});},contains:function(p){if(p.x!=null&&p.y!=null){var posY=0,posYMax=0,posX=0,posXMax=0;for(var i in this.multiline){switch(this.font.baseLine){case'top':posY=this.multiline[i].y;posYMax=this.multiline[i].y+this.font.size;break;case'middle':posY=this.multiline[i].y-this.font.size/2;posYMax=this.multiline[i].y+this.font.size/2;break;case'bottom':posY=this.multiline[i].y-this.font.size;posYMax=this.multiline[i].y;break;case'alphabetic':case'ideographic':posY=this.multiline[i].y-this.font.size;posYMax=this.multiline[i].y;break;}
switch(this.font.textAlign){case'left':posX=this.position.x;posXMax=this.position.x+this.multiline[i].width;break;case'center':posX=this.position.x-this.multiline[i].width/2;posXMax=this.position.x+this.multiline[i].width/2;break;case'right':posX=this.position.x-this.multiline[i].width;posXMax=this.position.x;break;}
if(p.x>posX&&p.y>posY&&p.x<posXMax&&p.y<posYMax){return true;}}}
return false;}};kan.extend(kan.Text,kan.Shape);kan.Rectangle=function(settings){this.size=new kan.Size();if(settings.borderRadius&&typeof(settings.borderRadius)=='number'){this.borderRadius={topLeft:settings.borderRadius,topRight:settings.borderRadius,bottomLeft:settings.borderRadius,bottomRight:settings.borderRadius};delete settings.borderRadius;}
kan.Shape.call(this,settings);};kan.Rectangle.prototype={info:{type:'Rectangle',getType:function(){return kan.Rectangle;}},size:null,currentPosition:null,getOrigin:function(){return new kan.Vector2({x:this.position.x+this.size.width/2,y:this.position.y+this.size.height/2});},borderRadius:null,draw:function(data){var ctx=data.context;this.graphics.beforedraw(ctx);if(this.fill||this.stroke){if(this.fill){ctx.fillStyle=this.fill instanceof kan.Color?this.fill.toRGBA():this.fill;}
if(this.stroke){ctx.strokeStyle=this.stroke instanceof kan.Color?this.stroke.toRGBA():this.stroke;}
ctx.lineWidth=this.lineWidth;this.isRounded?this._setRoundedRectPath(ctx):this._setRectPath(ctx);if(this.fill){ctx.fill();}
if(this.stroke){ctx.stroke();}}
this.graphics.afterdraw(ctx);},contains:function(o){var tp=this.currentPosition?this.currentPosition:this.position;if(o.inheritsof(kan.Point)){return(o.x>tp.x&&o.x<tp.x+this.size.width&&o.y>tp.y&&o.y<tp.y+this.size.height);}else if(o.inheritsof(kan.Rectangle)){var p=o.currentPosition?o.currentPosition:o.position;return(p.x>tp.x&&p.y>tp.y&&p.x+o.size.width<=tp.x+this.size.width&&p.y+o.size.height<=tp.y+this.size.height);}
return false;},equals:function(o){if(o.inhertitsof&&o.inheritsof(kan.Rectangle)){return o.position.x==this.position.x&&o.position.y==this.position.y&&o.size.width==this.size.width&&o.size.height==this.size.height;}else if(typeof(o)=='number'){return this.position.x==o&&this.position.y==o&&this.size.width==o&&this.size.height==o;}
return false;},compare:function(o){if(!o.inheritsof(kan.Rectangle)){return null;}
var x=0,y=0,w=0,h=0;if(this.position.x>o.position.x){x=1;}else if(this.position.x<o.position.x){x=-1;}
if(this.position.y>o.position.y){y=1;}else if(this.position.y<o.position.y){y=-1;}
if(this.size.width>o.size.width){w=1;}else if(this.size.width<o.size.width){w=-1;}
if(this.size.height>o.size.height){h=1;}else if(this.size.height<o.size.height){h=-1;}
return new kan.Rectangle({position:new kan.Point({x:x,y:y}),size:new kan.Size({width:w,height:h})});},clone:function(){var fill=this.fill instanceof kan.Color?this.fill.clone():this.fill;var stroke=this.stroke instanceof kan.Color?this.stroke.clone():this.stroke;return new kan.Rectangle({position:this.position.clone(),size:this.size.clone(),fill:fill,stroke:stroke,amplitude:this.floating.amplitude,speed:this.floating.speed,clickable:this.clickable,draggable:this.draggable});},getPoint:function(tob,lor){if(tob=='top'){return lor=='left'?this.position:new kan.Point({x:this.position.x+this.size.width,y:this.position.y});}else{return lor=='left'?new kan.Point({x:this.position.x,y:this.position.y+this.size.height}):new kan.Point({x:this.position.x+this.size.width,y:this.position.y+this.size.height});}
return null;},_setRoundedRectPath:function(context){var topRightPositionX=this.getPoint('top','right').x,bottomLeftPositionY=this.getPoint('bottom','left').y,radius=this.borderRadius;context.beginPath();context.moveTo(this.position.x+radius.topLeft,this.position.y);context.lineTo(topRightPositionX-radius.topRight,this.position.y);context.quadraticCurveTo(topRightPositionX,this.position.y,topRightPositionX,this.position.y+radius.topRight);context.lineTo(topRightPositionX,bottomLeftPositionY-radius.bottomRight);context.quadraticCurveTo(topRightPositionX,bottomLeftPositionY,topRightPositionX-radius.bottomRight,bottomLeftPositionY);context.lineTo(this.position.x+radius.bottomRight,bottomLeftPositionY);context.quadraticCurveTo(this.position.x,bottomLeftPositionY,this.position.x,bottomLeftPositionY-radius.bottomLeft);context.lineTo(this.position.x,this.position.y+radius.topLeft);context.quadraticCurveTo(this.position.x,this.position.y,this.position.x+radius.topLeft,this.position.y);},isRounded:function(){return(this.borderRadius.topLeft==0&&this.borderRadius.topRight==0&&this.borderRadius.bottomLeft==0&&this.borderRadius.bottomRight==0);},_setRectPath:function(context){context.beginPath();context.moveTo(this.position.x,this.position.y);context.LineTo(this.position.x+this.size.width,this.position.y);context.LineTo(this.position.x+this.size.width,this.position.y+this.size.height);context.LineTo(this.position.x,this.position.y+this.size.height);context.LineTo(this.position.x,this.position.y);}};kan.extend(kan.Rectangle,kan.Shape);kan.Circle=function(settings){kan.Shape.call(this,settings);};kan.Circle.prototype={info:{type:'Circle',getType:function(){return kan.Circle;}},currentPosition:null,radius:0,draw:function(data){var ctx=data.context;this.graphics.beforedraw(ctx);if(this.radius>0&&this.fill||this.stroke&&this.radius>0){ctx.beginPath();ctx.arc(this.currentPosition.x,this.currentPosition.y,this.radius,0,Math.PI*2);if(this.fill){ctx.fillStyle=this.fill instanceof kan.Color?this.fill.toRGBA():this.fill;ctx.fill();}
if(this.stroke){ctx.strokeStyle=this.stroke instanceof kan.Color?this.stroke.toRGBA():this.stroke;ctx.lineWidth=this.lineWidth;ctx.stroke();}}
this.graphics.afterdraw(ctx);},contains:function(c){var d=0,tp=this.currentPosition?this.currentPosition:this.position;if(c.inheritsof(kan.Point)){d=kan.Vector2.distance(tp,c);if(this.isClicked){this.isClicked=false;}
return(d<this.radius);}else if(c.inheritsof(kan.Circle)){d=kan.Vector2.distance(tp,c.position);return d<(this.radius+c.radius);}
return false;},equals:function(o){if(o.inheritsof(kan.Circle)){return o.position.x==this.position.x&&o.position.y==this.position.y&&this.radius==o.radius;}
return false;},compare:function(o){if(o.inheritsof(kan.Shape)){var r=0;if(this.radius>o.radius){r=1;}else if(this.radius<o.radius){r=-1;}
return new kan.Circle({position:this.position.compare(o.position),currentPosition:this.currentPosition.compare(o.currentPosition),radius:r});}
return false;},clone:function(){var fill=this.fill instanceof kan.Color?this.fill.clone():this.fill;var stroke=this.stroke instanceof kan.Color?this.stroke.clone():this.stroke;return new kan.Circle({position:this.position.clone(),radius:this.radius,fill:fill,stroke:stroke,lineWidth:this.lineWidth,amplitude:this.float.amplitude,speed:this.float.speed,clickable:this.clickable,draggable:this.draggable});}};kan.extend(kan.Circle,kan.Shape);kan.Image=function(settings){this.offset=new kan.Rectangle();this.size=new kan.Size();this.contains=kan.Rectangle.prototype.contains.bind(this);kan.Shape.call(this,settings);if(typeof(this.image)=='string'){if(this.image.charAt(0)=='#'){this.image=document.getElementById(this.image.substr(1,this.image.length));}else{var src=this.image;this.image=new Image();this.image.src=src;}}else{}
if(this.size.equals(0)){var that=this;this.image.onload=function(){that.size.width=this.width;that.size.height=this.height;that.isLoaded=true;};}};kan.Image.prototype={info:{type:'Image',getType:function(){return kan.Image;}},isLoaded:false,position:null,size:null,offset:null,image:null,draw:function(data){if(this.image&&this.isLoaded){this.graphics.beforedraw(data.context);if(!this.offset.equals(0)){data.context.drawImage(this.image,this.offset.position.x,this.offset.position.y,this.offset.size.width,this.offset.size.height,this.currentPosition.x,this.currentPosition.y,this.size.width,this.size.height);}else{data.context.drawImage(this.image,this.currentPosition.x,this.currentPosition.y,this.size.width,this.size.height);}
this.graphics.afterdraw(data.context);}},contains:null};kan.extend(kan.Image,kan.Shape);kan.Timer=function(seconds){this.base=kan.Timer.time;this.last=kan.Timer.time;this.target=seconds||0;};kan.Timer.prototype={info:{type:'Timer',getType:function(){return kan.Timer;}},last:0,base:0,target:0,pausedAt:0,set:function(seconds){this.target=seconds||0;this.base=kan.Timer.time;this.pausedAt=0;},reset:function(){this.base=kan.Timer.time;this.pausedAt=0;},tick:function(){var delta=kan.Timer.time-this.last;this.last=kan.Timer.time;return(this.pausedAt?0:delta);},delta:function(){return(this.pausedAt||kan.Timer.time)-this.base-this.target;},pause:function(){if(!this.pausedAt){this.pausedAt=kan.Timer.time;}},unpause:function(){if(this.pausedAt){this.base+=kan.Timer.time-this.pausedAt;this.pausedAt=0;}}};kan.Timer._last=0;kan.Timer.time=Number.MIN_VALUE;kan.Timer.timeScale=1;kan.Timer.maxStep=0.05;kan.Timer.step=function(){var current=Date.now();var delta=(current-kan.Timer._last)/1000;kan.Timer.time+=Math.min(delta,kan.Timer.maxStep)*kan.Timer.timeScale;kan.Timer._last=current;};kan.extend(kan.Timer,kan.Object);kan.Stage=function(settings){kan.Object.call(this,settings);this.timer=new kan.Timer();this.layers=new Array();};kan.Stage.prototype={info:{type:'Stage',getType:function(){return kan.Stage;}},timer:null,layers:null,update:function(){for(var i in this.layers){this.layers[i].update(this);}},draw:function(){for(var i in this.layers){this.layers[i].draw(this);}},stop:function(){this.isRunning=false;clearTimeout();clearInterval();},run:function(){this.isRunning=true;kan.Timer.step();this.timer.reset();this._loop();},_loop:function(){if(this.isRunning){kan.Timer.step();this.update();kan.Timer.step();this.draw();window.requestAnimFrame(this._loop.bind(this));}},add:function(o){this.layers.push(o);},equals:function(o){if(!o.inheritsof){return false;}
return this.ID===o.ID&&o.inheritsof(kan.Stage);}};kan.extend(kan.Stage,kan.Object);kan.Layer=function(settings){this.info.supportedEvents=new Object();this.offset=new kan.Point();this.components=new kan.ShapeList();this.graphics=new kan.Graphics();if(settings.canvas){if(typeof(settings.canvas)=='string'){this.canvas=document.getElementById(settings.canvas);if(settings.width){this.canvas.width=settings.width;}
if(settings.height){this.canvas.height=settings.height;}
this.context=this.canvas.getContext('2d');delete settings.canvas;}else if(settings.canvas instanceof HTMLCanvasElement){this.context=settings.canvas.getContext('2d');if(settings.width){settings.canvas.width=settings.width;}
if(settings.height){settings.canvas.height=settings.height;}}}
kan.Object.call(this,settings);};kan.Layer.prototype={info:{type:'Layer',getType:function(){return kan.Layer;},supportedEvents:null},canvas:null,context:null,width:0,height:0,offset:null,graphics:null,components:null,addTo:function(stage){if(stage instanceof Array){stage.push(this);}else if(stage.add){stage.add(this);}
return this;},add:function(component){component.info.layer=this;this.components.add(component);for(var i in component.events)
{if(!this.info.supportedEvents[i]){var addEventFunc=this.canvas.addEventListener?'addEventListener':'attachEvent';this.canvas[addEventFunc](i,(function(e){if(e instanceof MouseEvent){kan.Mouse._update(e);e.mousePosition=kan.Mouse.position.rel;e.mouseAbsPosition=kan.Mouse.position.abs;}
e.target=(function(event){return event.originalTarget||event.toElement||event.target;})(e);for(var i=this.components.items.length-1;i>-1;i--){if(!this.components.items[i].events.execute(e)){return false;}}}).bind(this),false);this.info.supportedEvents[i]=true;if(!this.mouseUpCorrection){document.addEventListener('mouseup',(function(e){e.target=(function(event){return event.originalTarget||event.toElement||event.target;})(e);if(e.target!=this.canvas){this.components.each(function(){this.events.reset();});}}).bind(this),false);this.mouseUpCorrection=true;}}}},update:function(stage){var data={context:this.context,timer:stage.timer.delta(),mouse:this.lastMouse};for(var index=0;index<this.components.items.length;index++){this.components.items[index].update(data);}
this.components.sort(function(c1,c2){return c1.zIndex>c2.zIndex?1:c1.zIndex<c2.zIndex?-1:0;});},draw:function(stage){this.context.clearRect(0,0,this.width,this.height);this.graphics.beforedraw(this.context);var data={context:this.context,timer:stage.timer.delta(),mouse:this.lastMouse};for(var index=0;index<this.components.items.length;index++){this.components.items[index].draw(data);}
this.graphics.afterdraw(this.context);},equals:function(o){if(!o.inheritsof){return false;}
return this.ID===o.ID&&o.inheritsof(kan.Layer);}};kan.extend(kan.Layer,kan.Object);})();